{% extends "layout.html" %}


{% block main %}

<html lang="en">
    <p><center>Quiz</center></p>

    <center><p id="question"></p></center>
    <p id='time'></p>
    <p id='score'></p>
    <div>
      <center><p><button id='answer1' type="button" class="btn btn-primary" onclick='check(this.innerHTML)'></button></p></center>
      <center><p><button id='answer2' type="button" class="btn btn-succes" onclick='check(this.innerHTML)'></button></p></center>
      <center><p><button id='answer3' type="button" class="btn btn-info" onclick='check(this.innerHTML)'></button></p></center>
      <center><p><button id='answer4' type="button" class="btn btn-warning" onclick='check(this.innerHTML)'></button></p></center>
    </div>

    <!--<hr style="width: 30%;">-->
    <!--<div>-->
    <!--  <p>-->
    <!--  <form action="fetch_question()" method="get">-->
    <!--    <p><center><button type="submit" class="btn btn-dark">Next Question</button></center></p>-->
    <!--  </form>-->
    <!--  </p>-->
    <!--</div>-->
    <!--<br>-->

    <hr style="width: 30%;">
    <div>
      <p>
      <form action="/" method="get">
        <p><center><button type="submit" class="btn btn-danger">Stop quiz</button></center></p>
      </form>
      </p>
    </div>

    <div class="form-popup" id="top10form">
      <form>
        <h2>Congratulations! You made the top 10!</h2>

        <label for="username"><b>Username</b></label>
        <input type="text" placeholder="Enter username" name="username" required>


        <button type="submit" class="btn btn-success">See Results</button>
        <hr>
        <button type="submit" class="btn btn-secondary" onclick="closePopup()">Close</button>
      </form>
    </div>
</html>

<script>
// initiate global variables

var score = 70;
var timer = 4;

var correct_answer;
var answers_length;
var difficulty_score;
var category;

// open popup if in top10
function openPopup() {
  document.getElementById("top10form").style.display = "block";
  document.getElementById("question").style.display = "none";
}

//close popup
function closePopup() {
  document.getElementById("top10form").style.display = "none";
}

// display default values of the timer and score (60, 0)
document.getElementById('time').innerHTML = timer;
document.getElementById('score').innerHTML = score;

// generate a question
fetch_question();

// close popup until needed
closePopup();

// decrement time every second
setInterval(countdown, 1000);



// check the answer
function check(input) {
  if (input == correct_answer) {
    score++; // if correct increment score
    timer = timer + difficulty_score; // add the amount of time appropriate for the difficulty of the question
    document.getElementById("time").style.backgroundColor = "LawnGreen"; // turn the background of the time green to make the time increment visible
    document.getElementById('score').innerHTML = score; // display the incremented score
  }
  else {
    timer = timer + (difficulty_score - 4); // subract the amount of time
    document.getElementById("time").style.backgroundColor = "red"; // make visible subraction to time
  }
  fetch_question(); // generate a new question
  setTimeout(reset_color, 300); // return timer to default color after a short time
}
function reset_color() { //
  document.getElementById("time").style.backgroundColor = "white";
}

var checked = false
function countdown() {
  if (timer >= 0) {
    document.getElementById('time').innerHTML = timer;
    timer--;

  }
  else if (timer <= 0) {
    if (!executed) {
      check_score();
      var executed = true;
    }
  }
}


function check_score() {
  if (timer < 0) {
    document.getElementById('time').innerHTML = 0;
    fetch('/check?score=' + score).then((response) => {
      return response.json();
    })

    .then((data) => {
      // var check_executed == True;
      if (data.length == 2) {
        openPopup();
      }
      else {
        alert(data);
        location.replace("/leaderboard");
      }
    });
  }
}


function fetch_question(){
  fetch('https://opentdb.com/api.php?amount=1&category=9') // request api
    .then((response) => {
      return response.json();
    })

    .then((data) => {
      Question = data.results[0];
      correct_answer = Question.correct_answer;
      if (Question.difficulty == "easy") {
        difficulty_score = 1;
      }
      else if (Question.difficulty == 'medium') {
        difficulty_score = 2;
      }
      else {
        difficulty_score = 3;
      }

      category = Question.category;

      let answers = Question.incorrect_answers; // creates an array with all the anwers correct and incorrect
      answers.push(Question.correct_answer);

      answers_length = answers.length;

      // sort True/False question as True, False
      if (answers.length == 2) {
        answers.sort();
        answers.reverse();
      }
      // randomize multiple choice questions
      else {
      answers.sort(() => Math.random() - 0.5);
      }
      if (answers_length == 2) { // remove the 3rd and 4th button if True/False question
        document.getElementById('answer3').style.display = "none";
        document.getElementById('answer4').style.display = "none";
      }
      else {
        document.getElementById('answer3').style.display = "block";
        document.getElementById('answer4').style.display = "block";
      }
      // displaying question and answers
      document.getElementById('question').innerHTML = Question.question;
      document.getElementById('answer1').innerHTML = answers[0];
      document.getElementById('answer2').innerHTML = answers[1];
      document.getElementById('answer3').innerHTML = answers[2];
      document.getElementById('answer4').innerHTML = answers[3];

    });

}



</script>

{% endblock %}